<!DOCTYPE html>
<html>
	<head>
		<title>Map Test</title>
		<meta charset="UTF-8">
		<style>
		
			#mapContainer {
				display:block;
				margin:0 auto;
			}
			
			#mapContainer path {
			  stroke:#FFF;
			}
			
			.popup {

			}
			
			text.popup-country {
				fill: #333;
				font-family: sans-serif;
				font-weight: bold;
				font-size: 1em;
			}
			
			text.popup-data {
				fill: #333;
				font-family: sans-serif;
				font-size: 0.8em;
			}
			
		</style>
		
		<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
		<script src = "http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.js"></script>
	</head>

	<body>
		<div id="mapContainer"></div>
	</body>
	
	<script>
		function draw() {
		var width = 800;
		var height = Math.floor(width / 2);
		var pop_width = 200
		var pop_height = 100
		var map = d3.select("#mapContainer").append("svg")
			.attr("id", "mapContainer")
			.attr("width", width)
			.attr("height", height)

		projection = d3.geo.equirectangular().scale((width/640)*100).translate([width/2, height/2]);
		var path = d3.geo.path().projection(projection);
		d3.json('data/world-countries.json', function(error, collection) {
		
			d3.json('data/data.json', function(err, data) {
				var max = 0;
				
				for(var i = 0; i < data.length; i++) {
					var id = data[i].country;
					max = Math.max(max, data[i].count);
					for(var j = 0; j < collection.features.length; j++) {
						if(collection.features[j].id === id) {
							collection.features[j].properties.count = data[i].count;
							collection.features[j].properties.first = data[i].first;
							collection.features[j].properties.last = data[i].last;
						}
					}
				}
			
				var scale = d3.scale.pow().exponent(0.43)
					.domain([0, max])
					.range(["#FFFF00", "#CC0000"])
			
				map.selectAll('path').data(collection.features, function(d) {return d.id;}).enter()
					.append('path')
					.attr('d', path)
					.attr("class", "nation")
					.attr("width", width)
					.attr("height", width/2)
					.attr("fill", function(d) {
						var x = 2;
						if(d.properties.hasOwnProperty("count")) {
							return scale(d.properties.count);
						} else {
							return "black";
						};
					})
					.on("mouseenter", function(d) {
						var props = d.properties
						if(props.hasOwnProperty("count") == false) {
							props.count = "NA"
							props.first = "NA"
							props.last = "NA"
						}
						d3.select("g.popup")
							.transition()
								.delay(100)
								.duration(200)
								.attr("opacity", 0.9)
								.style("display", "block");
						d3.select("text.popup-country")
							.text(props.name);
						d3.select("text.popup-count")
							.text("Total Downloads: " + props.count);
						d3.select("text.popup-first")
							.text("First Download: " + props.first);
						d3.select("text.popup-last")
							.text("Last Download: " + props.last);
					})
					.on("mousemove", function(d) {
						var m = d3.mouse(this);
						var x = m[0] + 15;
						var y = m[1] + 5;
						if((x + pop_width) > width) {
							x = m[0] - (pop_width + 5)
						}
						if((y + pop_height) > height) {
							y = m[1] - (pop_height + 5)
						}
						d3.select("g.popup")
							.attr("transform", "translate(" + x + "," + y + ")")
					})
					.on("mouseleave", function(d) {
							d3.select("g.popup")
							.transition()
								.duration(250)
								.delay(75)
									.attr("opacity", 0)
									.style("display", "none")
					});
					
					
				var popup = map.append('g')
					.attr("class", "popup")
					.attr("opacity", 0)
				popup.append("rect")
					.attr("class", "popup")
					.attr("width", pop_width)
					.attr("height", pop_height)
					.attr("rx", "5px")
					.attr("fill", "#DDD")
					.attr("stroke", "#555")
					.attr("stroke-width", "2px");
				popup.append("text")
					.attr("x", "10px")
					.attr("y", "10px")
					.attr("dy", "0.67em")
					.attr("class", "popup-country");
				popup.append("text")
					.attr("x", "10px")
					.attr("y", "35px")
					.attr("dy", "0.67em")
					.attr("class", "popup-data popup-count");
				popup.append("text")
					.attr("x", "10px")
					.attr("y", "55px")
					.attr("dy", "0.67em")
					.attr("class", "popup-data popup-first");
				popup.append("text")
					.attr("x", "10px")
					.attr("y", "75px")
					.attr("dy", "0.67em")
					.attr("class", "popup-data popup-last");
					

			});
		
				
		});
		
		}
		draw();
	</script>

</html> 